<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
  </head>

  <body>
    <header class="flex">
      <h1>SmartLamp</h1>
    </header>
    <div class="container mt-2">
      <form method="get" id="submitForm">
        <div class="row-color">
          <div class="left">
            <div class="color-picker">
              <!-- <canvas id="colors" width="400" height="400"></canvas> -->
              <canvas id="colors" onmousemove="echoColor(event)"></canvas>
              <div id="inner-picker"></div>
              <div id="color-slider">
                <div class="mt-3">
                  <label for="red">Red</label>
                  <input type="range" name="red" id="red" min="0" max="255" value="255">
                </div>
                <div class="mt-3">
                  <label for="green">Green</label>
                  <input type="range" name="green" id="green" min="0" max="255" value="0">
                </div>
                <div class="mt-3">
                  <label for="blue">Blue</label>
                  <input type="range" name="blue" id="blue" min="0" max="255" value="0">
                </div>
              </div>
            </div>
          </div>
          <div class="right">
            <input type="range" name="brightness" min="0" max="255" class="slider">
          </div>
        </div>

        <br />
        <div class="flex mt-1">
          <button type="button" class="btn reset" onclick="manualOption()">Manual</button>
          <button type="submit" class="btn apply">Apply</button>
        </div>
      </form>
    </div>

    <footer class="text-center">
      <form method="get">
        <input type="text" name="power" hidden>
        <button type="submit" class="power">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
            <path style="fill: white;"
              d="M14 12h-4v-12h4v12zm4.213-10.246l-1.213 1.599c2.984 1.732 5 4.955 5 8.647 0 5.514-4.486 10-10 10s-10-4.486-10-10c0-3.692 2.016-6.915 5-8.647l-1.213-1.599c-3.465 2.103-5.787 5.897-5.787 10.246 0 6.627 5.373 12 12 12s12-5.373 12-12c0-4.349-2.322-8.143-5.787-10.246z" />
          </svg>
        </button>
      </form>
    </footer>

    <script>
      // console.log(localStorage.getItem("lamp"));
      window.addEventListener("load", () => {
        registerServiceWorker();
      })

      function registerServiceWorker() {
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('/sw.js').then(reg => {
            console.log('Service Worker registered successfully');
          })
            .catch(e => console.error('Error during service worker registration:', e));
        } else {
          console.warn('Service Worker is not supported');
        }
      }

      let canvas = document.getElementById("colors");
      let graphics = canvas.getContext("2d");

      canvas.height = canvas.offsetHeight
      canvas.width = canvas.offsetWidth

      var CX = canvas.width / 2,
        CY = canvas.height / 2,
        sx = CX,
        sy = CY;

      for (var i = 0; i < 360; i += 0.1) {
        var rad = i * (2 * Math.PI) / 360;
        graphics.strokeStyle = "hsla(" + i + ", 100%, 50%, 1.0)";
        graphics.beginPath();
        graphics.moveTo(CX, CY);
        graphics.lineTo(CX + sx * Math.cos(rad), CY + sy * Math.sin(rad));
        graphics.stroke();
      }

      canvas.addEventListener("onmouseover", (e) => {
        echoColor(e)
        console.log("asd");
      })

      function echoColor(e) {
        var imgData = graphics.getImageData(e.layerX, e.layerY, 2, 2);
        let r = imgData.data[0];
        let g = imgData.data[1];
        let b = imgData.data[2];

        function ifColorExist(color) {
          if (r != 0 || g != 0 || b != 0) {
            return color
          }
        }

        let red = ifColorExist(r)
        let green = ifColorExist(g)
        let blue = ifColorExist(b)

        document.getElementById("red").value = red
        document.getElementById("green").value = green
        document.getElementById("blue").value = blue
        document.getElementById("inner-picker").style.backgroundColor = `rgb(${red}, ${green}, ${blue}`
      }

      function submit() {
        document.getElementById("submitForm").submit();
        let brightness = document.querySelector(".slider").value;
        let set = {
          red: r,
          green: g,
          blue: b,
          brightness: brightness
        }
        localStorage.setItem("lamp", JSON.stringify(set))
      }

      let hiddenColors = false
      document.getElementById("color-slider").style = "visibility:hidden"
      function manualOption() {
        hiddenColors = !hiddenColors
        document.getElementById("colors").style = (hiddenColors) ? "display:none" : "display:block"
        document.getElementById("inner-picker").style = (hiddenColors) ? "display:none" : "display:block"

        document.getElementById("color-slider").style = (hiddenColors) ? "visibility:unset" : "visibility:hidden"
        document.querySelector(".reset").innerText = (hiddenColors) ? "BACK" : "MANUAL"
      }
    </script>
  </body>

</html>